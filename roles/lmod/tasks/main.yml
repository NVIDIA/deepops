#
# ansible role to install lmod:
#
---
- name: "gather os specific variables"
  include_vars: "{{ item }}"
  with_first_found:
    - files:
      - "{{ ansible_distribution|lower }}-{{ ansible_architecture|lower }}.yml"
      - "{{ ansible_distribution|lower }}.yml"
      - "{{ ansible_os_family|lower }}.yml"
      paths:
      - ../vars
      skip: true
  tags:
    - always
- name: RedHat | add epel repo
  yum_repository:
    name: epel
    description: EPEL YUM repo
    baseurl: "{{ lmod_rhel_epel_repo_baseurl }}"
    gpgkey: "{{ lmod_rhel_epel_repo_gpgkey }}"
  environment: "{{proxy_env if proxy_env is defined else {}}}"
  when: ansible_os_family == "RedHat"

- name: "install packages"
  become: yes
  apt:
    name:
    - bash
    - tcsh
    - lmod
    state: present
  when: ansible_os_family == "Debian"

- name: "install packages"
  become: yes
  yum:
    name:
    - bash
    - tcsh
    - Lmod
  when: ansible_os_family == "RedHat"

# see: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=891541
# lmod does not create posix.so in system libraries sir
# fix: symlink posix_c.so into posix.so
- name: "bugfix for lomd posix_c"
  become: yes
  file:
    src: "{{ lmod_sys_lib_dir }}/{{ item }}/posix_c.so"
    dest: "{{ lmod_sys_lib_dir }}/{{ item }}/posix.so"
    state: link
    force: yes
  with_items:
    - 5.1
    - 5.2
    - 5.3
  when: 
    - ansible_distribution == 'Ubuntu'
    - ansible_distribution_version == '18.04'
  tags:
    - bugfix

# see: https://bugs.launchpad.net/ubuntu/+source/lmod/+bug/1850237
# lmod has incorrect SYS_LUA_CPATH on arm64
# fix: sed -i 's/x86_64/aarch64/g' /usr/share/lmod/lmod/libexec/lmod
- name: "bugfix for sys_lua_path: find lua config files"
  become: yes
  find:
    paths: "/usr/share/lmod/lmod/libexec"
    patterns: "*"
    recurse: yes
  register: lua_config
  tags:
    - bugfix

- name: "bugfix for sys_lua_path: set the right arch"
  become: yes
  replace:
    path: "{{ item.path }}"
    regexp: 'x86_64-linux-gnu'
    replace: 'aarch64-linux-gnu'
  with_items: "{{ lua_config.files }}"
  when: ansible_os_family == "Debian" and ansible_architecture == "aarch64"
  tags:
    - bugfix

- name: "mkdir software path"
  become: yes
  file: path={{ sm_software_path }} state=directory
  tags:
    - configuration

- name: "mkdir module path"
  become: yes
  file: path={{ sm_module_path }} state=directory 
  tags:
    - configuration

- name: "clean previous lmod envirenment: collect auto loaders if any"
  become: yes
  find:
    paths: /etc/profile.d
    patterns: "*lmod*.sh"
  register: lmod_old_env
  tags:
    - configuration

- name: "clean previous lmod envirenment: remove auto loaders if any"
  become: yes
  file:
    path: "{{ item.path }}"
    state: absent
  with_items: "{{ lmod_old_env.files }}"
  tags:
    - configuration

- name: "upload lmod envirenment"
  become: yes
  template:
    src: templates/lmod-{{ ansible_distribution | lower }}.j2
    dest: /tmp
    owner: root
    group: root
    mode: 0777
  tags:
    - configuration

- name: "enable auto-load lmod environment"
  become: yes
  blockinfile:
    block: "{{ lookup('file', '/tmp/lmod-{{ ansible_distribution | lower }}.j2') }}"
    dest: "{{ lmod_sys_cfg_file }}"
    backup: yes
  tags:
    - configuration

- name: "export the lmod config file as a host-fact"
  set_fact:
    lmod_sys_cfg_file: "{{ lmod_sys_cfg_file }}"
  tags:
    - configuration
