---
- name: purge old slurm packages
  apt:
    name: slurm
    state: absent
    purge: yes
    autoremove: yes

- name: purge old slurm package config files
  file:
    path: "/etc/systemd/system/{{ item }}"
    state: absent
  with_items:
    - slurmctld.service
    - slurmd.service
    - slurmdbd.service
  notify: daemon reload

- name: add key
  apt_key:
    keyserver: keyserver.ubuntu.com
    id: C1F8C45E6399D9A94E55ECE17883B3001AB80A5C

- name: repo ppa:luke-yeager/slurm
  apt_repository:
    repo: ppa:luke-yeager/slurm

- name: install slurm
  apt:
    name: "{{ item }}"
    state: present
  with_items:
    - slurm-wlm
    - slurmdbd
  when: is_controller

- name: install slurm
  apt:
    name: "{{ item }}"
    state: present
  with_items:
    - slurmd
    - slurm-client
    - libpam-slurm
    - libpam-slurm-adopt
  when: is_compute
