#
# an ansible role to install EasyBuild:
#
---
- name: "check if install prefix exists"
  stat:
    path: "{{ sm_prefix }}"
  register: sm_prefix_test

- fail:
    msg: "failed as install prefix does not exist"
  when: sm_prefix_test.stat.exists == false

- name: "install needed packages"
  become: yes
  action: apt name=python-setuptools state=latest
  when: ansible_os_family == "Debian"

- name: "install needed packages"
  become: yes
  action: yum name=python-setuptools state=latest
  when: ansible_os_family == "RedHat"

- name: "check if easybuild is installed"
  find:
    paths: "{{ sm_prefix }}"
    file_type: file
    patterns: "^eb$"
    use_regex: yes
    recurse: yes
  register: ebsw_exe
  ignore_errors: yes

- name: "download bootstrap script"
  get_url: url="{{ item.url }}" dest="{{ item.dest }}" mode='u=rwx,g=rwx,o=rx' force=yes
  with_items:
    - url: "{{ eb_bootstrap_url }}" 
      dest: '/tmp'
  when: not ebsw_exe.matched

# ansible doesn't run task in a login shell, so we have to use sudo -ilc
- name: "install latest easybuild version"
  shell: /bin/bash -ilc '/tmp/bootstrap_eb.py {{ sm_prefix }}'
  when: not ebsw_exe.matched

- name: "get easybuild version"
  shell: ls {{ sm_prefix }}/software/EasyBuild/
  args:
    executable: /bin/bash
  register: ebsw_version
  tags:
    - configuration
